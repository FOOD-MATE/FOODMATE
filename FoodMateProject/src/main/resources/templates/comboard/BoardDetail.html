<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="assets/css/main.css">
<link rel="stylesheet"
	href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<script src="https://code.jquery.com/jquery-3.6.3.min.js"></script>
<script type="text/javascript" th:inline="javascript">
	function go_list() {
		var theForm = document.frm;
		theForm.method = "get";
		theForm.action = "board_list";
		theForm.submit();
	}

	function board_update() {
		var theForm = document.frm;
		theForm.method = "get";
		theForm.action = "board_update";
		theForm.submit();
	}

	function board_delete() {
		var theForm = document.frm;
		theForm.method = "get";
		theForm.action = "board_delete";
		theForm.submit();

	}

	//댓글등록	
	function reply_save() {
		var theForm = document.replyfrm;
		theForm.method = "post";
		theForm.action = "reply_save";
		theForm.submit();
	}

	//댓글출력
	function reply_list() {
		var seq = $('#seq').val();

		$.ajax({
			url : '/reply_list',
			type : 'post',
			data : {
				seq : seq
			},
			success : function(response) {
				var updatedContent = $(response).find('#reply_list').html(); // 응답에서 댓글 목록 부분만 추출
				$('#reply_list').html(updatedContent); // 페이지의 댓글 목록 부분만 업데이트
			},
			error : function(error) {
				console.error("댓글 로드 중 오류 발생: ", error);
			}
		});
	}

	// 페이지 로드 완료 후 댓글 목록 로드
	$(document).ready(function() {
		reply_list();
	});

	//클립보드복사
	function copyboard() {
		var copy = document.createElement('input'), text = window.location.href;

		document.body.appendChild(copy);
		copy.value = text;
		copy.select();
		document.execCommand('copy');
		document.body.removeChild(copy);

		alert('복사되었습니다');
	}

	//추천
	function goodpoint_plus(button) {
		var theForm = document.frm;
		theForm.method = "post";
		theForm.action = "goodpoint";
		theForm.submit();

	}

	

function deleteReply(replynum, event) {
    event.preventDefault(); // 기본 이벤트 방지

    if (confirm('이 댓글을 삭제하시겠습니까?')) {
        fetch(`/reply_delete?replynum=${replynum}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ replynum: replynum })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`네트워크 응답이 올바르지 않습니다. 상태 코드: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                alert('댓글이 삭제되었습니다.');
                reply_list(); // 댓글 목록을 새로 고침
            } else {
                throw new Error(data.message); // 서버에서 처리 실패 시
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert(`댓글 삭제 중 오류가 발생하였습니다: ${error.message}`);
        });
    }
}


function toggleEditMode(button, event) {
    event.preventDefault();

    const replynum = button.getAttribute('data-replynum');
    const replyElement = button.closest(`tr[data-replynum='${replynum}']`);
    if (!replyElement) {
        console.error('Error: Unable to find the reply element.');
        return;
    }
    const contentView = replyElement.querySelector(`span[data-content-view='${replynum}']`);
    const contentEdit = replyElement.querySelector(`textarea[data-content-edit='${replynum}']`);
    const saveButton = replyElement.querySelector(`button[data-save-button='${replynum}']`);

    if (!contentView || !contentEdit || !saveButton) {
        console.error('Error: Unable to find the necessary HTML elements.');
        return;
    }

    if (contentView.style.display === 'none') {
        contentView.style.display = 'block';
        contentEdit.style.display = 'none';
        button.style.display = 'inline'; // 수정 버튼 표시
        saveButton.style.display = 'none'; // 저장 버튼 숨김
    } else {
        contentView.style.display = 'none';
        contentEdit.style.display = 'block';
        button.style.display = 'none'; // 수정 버튼 숨김
        saveButton.style.display = 'inline'; // 저장 버튼 표시
    }
}

//***** 댓글 내용 저장 *****
function saveChanges(button, event) {
    event.preventDefault(); // 기본 이벤트 방지

    // 댓글 번호를 가져옵니다.
    const replynum = button.getAttribute('data-replynum');
    const replyElement = button.closest(`tr[data-replynum='${replynum}']`);
    if (!replyElement) {
        console.error('Error: Unable to find the reply element.');
        return;
    }
    const content = replyElement.querySelector(`textarea[data-content-edit='${replynum}']`).value;

    // 디버깅: replynum과 content를 출력합니다.
    console.log('Reply Number:', replynum);
    console.log('Content:', content);

    // AJAX 요청을 통해 댓글 내용을 업데이트합니다.
    fetch('/reply_update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ replynum: replynum, content: content })
    })
    .then(response => {
        // 디버깅: 응답 상태 코드를 출력합니다.
        console.log('Response Status:', response.status);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert('댓글이 수정되었습니다.');
            replyElement.querySelector(`span[data-content-view='${replynum}']`).textContent = content;

            // 저장 후 수정 버튼과 저장 버튼의 상태를 조정합니다.
            const editButton = replyElement.querySelector(`button[data-replynum='${replynum}']`);
            editButton.style.display = 'inline'; // 수정 버튼 표시
            button.style.display = 'none'; // 저장 버튼 숨김

            const contentView = replyElement.querySelector(`span[data-content-view='${replynum}']`);
            const contentEdit = replyElement.querySelector(`textarea[data-content-edit='${replynum}']`);
            contentView.style.display = 'block'; // 내용 보기 표시
            contentEdit.style.display = 'none'; // 내용 편집 숨김
        } else {
            throw new Error(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('댓글 수정 중 오류가 발생했습니다: ' + error.message);
    });
}




    
</script>
</head>
<body>
	<article>
		<h1>유저 레시피 상세페이지</h1>
		<form name="frm" method="post">
			<input type="hidden" name="seq" id="seq"
				th:value="${Com_Board_DetailVO.seq}">
			<table id="Board_deatail_List">
				<tr>
					<td><img
						th:src="${Com_Board_DetailVO.com_recipe.att_file_no_mk}"
						style="width: 400px; height: 300px;" /></td>
					<td><a onclick="copyboard()"> <span
							class="material-symbols-outlined">share</span>공유하기
					</a> <th:block
							th:if="${session.goodPointStatusMap != null and session.goodPointStatusMap[Com_Board_DetailVO.seq] == 'on'}">
							<a style="color: red"
								th:attr="data-seq=${Com_Board_DetailVO.seq}"
								onclick="goodpoint_plus(this)"><span
								class="material-symbols-outlined" id="symbol_red">
									recommend</span>추천해제</a>
						</th:block> <th:block
							th:if="${session.goodPointStatusMap == null or session.goodPointStatusMap[Com_Board_DetailVO.seq] != 'on'}">
							<a th:attr="data-seq=${Com_Board_DetailVO.seq}"
								onclick="goodpoint_plus(this)"><span
								class="material-symbols-outlined"> recommend</span>추천하기</a></td>
					</th:block>
				</tr>
				<tr>
					<th width="20%">요리명</th>
					<td>[[${Com_Board_DetailVO.com_recipe.rcp_nm}]]</td>
				</tr>
				<tr>
					<th>등록일</th>
					<td>[[${#dates.format(Com_Board_DetailVO.d_regdate,
						"yyyy-MM-dd") }]]</td>
				</tr>
				<tr>
					<th>작성자</th>
					<td>[[${Com_Board_DetailVO.member_data.id}]]</td>
				</tr>
				<tr>
					<th>조회수</th>
					<td>[[${Com_Board_DetailVO.cnt}]]</td>
				</tr>
				<tr>
					<th>추천수</th>
					<td>[[${Com_Board_DetailVO.goodpoint}]]</td>
				</tr>
				<tr>
					<th>분류</th>
					<td>[[${Com_Board_DetailVO.com_recipe.rcp_pat2}]]</td>
				</tr>
				<tr>
					<th>주재료</th>
					<td>[[${Com_Board_DetailVO.com_recipe.hash_tag}]]</td>
				</tr>
				<tr>
					<th>재료</th>
					<td>[[${Com_Board_DetailVO.com_recipe.rcp_parts_dtls}]]</td>
				</tr>
			</table>
			<h3>조리법</h3>
			<table id="Board_deatail_List">
				<tr>
					<th:block
						th:if="${Com_Board_DetailVO.com_recipe.manual_img01 != null }">
						<td><img
							th:src="${Com_Board_DetailVO.com_recipe.manual_img01}"
							style="width: 200px; height: 180px;" /></td>
						<td>[[${Com_Board_DetailVO.com_recipe.manual01}]]</td>
					</th:block>
				</tr>
				<tr>
					<th:block
						th:if="${Com_Board_DetailVO.com_recipe.manual_img02 != null }">
						<td><img
							th:src="${Com_Board_DetailVO.com_recipe.manual_img02}"
							style="width: 200px; height: 180px;" /></td>
						<td>[[${Com_Board_DetailVO.com_recipe.manual02}]]</td>
					</th:block>
				</tr>
				<tr>
					<th:block
						th:if="${Com_Board_DetailVO.com_recipe.manual_img03 != null }">
						<td><img
							th:src="${Com_Board_DetailVO.com_recipe.manual_img03}"
							style="width: 200px; height: 180px;" /></td>
						<td>[[${Com_Board_DetailVO.com_recipe.manual03}]]</td>
					</th:block>
				</tr>
				<tr>
					<th:block
						th:if="${Com_Board_DetailVO.com_recipe.manual_img04 != null }">
						<td><img
							th:src="${Com_Board_DetailVO.com_recipe.manual_img04}"
							style="width: 200px; height: 180px;" /></td>
						<td>[[${Com_Board_DetailVO.com_recipe.manual04}]]</td>
					</th:block>
				</tr>
				<tr>
					<th:block
						th:if="${Com_Board_DetailVO.com_recipe.manual_img05 != null }">
						<td><img
							th:src="${Com_Board_DetailVO.com_recipe.manual_img05}"
							style="width: 200px; height: 180px;" /></td>
						<td>[[${Com_Board_DetailVO.com_recipe.manual05}]]</td>
					</th:block>
				</tr>
				<tr>
					<th:block
						th:if="${Com_Board_DetailVO.com_recipe.manual_img06 != null }">
						<td><img
							th:src="${Com_Board_DetailVO.com_recipe.manual_img06}"
							style="width: 200px; height: 180px;" /></td>
						<td>[[${Com_Board_DetailVO.com_recipe.manual06}]]</td>
					</th:block>
				</tr>
			</table>
		</form>
		<h3>Comment</h3>
				<form name="replyfrm" method="get">
			<input type="hidden" name="seq" id="seq"
				th:value="${Com_Board_DetailVO.seq}">
			<table id="Board_deatail_List">
				<tr>
					<td colspan="2"><textarea name="reply_content"
							id="reply_content" rows="3" cols="50"></textarea> <input
						type="button" class="btn" value="저장" onClick="reply_save()"></td>
				</tr>
			</table>
			<table id="reply_list">
    <tr>
        <th></th>
    </tr>
    <th:block th:each="replyVO : ${ReplyList}">
        <tr th:attr="data-replynum=${replyVO.replynum}">
            <td th:text="${replyVO.member_data.id}">User ID</td>
            <td>
                <span th:text="${replyVO.content}" th:attr="data-content-view=${replyVO.replynum}">Reply Content</span>
                <textarea th:attr="data-content-edit=${replyVO.replynum}" style="display: none;" th:text="${replyVO.content}"></textarea>
            </td>
            <td th:if="${session.loginUser != null and replyVO.member_data.id.equals(session.loginUser.id)}">
                <button th:attr="data-replynum=${replyVO.replynum}" onclick="toggleEditMode(this, event);">수정</button>
                <button th:attr="data-replynum=${replyVO.replynum},data-save-button=${replyVO.replynum}" onclick="saveChanges(this, event);" style="display: none;">저장</button>
                <button th:attr="onclick='deleteReply(' + ${replyVO.replynum} + ', event)'">삭제</button>
            </td>
        </tr>
    </th:block>
</table>

		</form>
		<form name="buttonfrm" method="get">
			<input type="hidden" name="seq" id="seq"
				value="[[${Com_Board_DetailVO.seq}]]"> <input type="button"
				class="btn" value="목록" onClick="go_list()">
			<th:block
				th:if="${session.loginUser != null and (Com_Board_DetailVO.member_data.id).equals(session.loginUser.id)}">
				<input type="button" class="btn" value="수정" onClick="board_update()">
				<input type="button" class="btn" value="삭제" onClick="board_delete()">
			</th:block>
		</form>
	</article>
</body>
</html>